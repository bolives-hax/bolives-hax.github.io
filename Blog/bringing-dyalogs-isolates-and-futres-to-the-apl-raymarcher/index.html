<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="bl0v3's blog" name=description><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ff7800 name=theme-color><link href=https://bolives-hax.github.io/Blog/bringing-dyalogs-isolates-and-futres-to-the-apl-raymarcher/ rel=canonical><title>making use of dyalog APL's isolates+futures in the the apl raymarcher - </title><link href=https://bolives-hax.github.io/style.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://bolives-hax.github.io/syntax-theme-dark.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=https://bolives-hax.github.io/syntax-theme-light.css rel=stylesheet><style>:root {--primary-color-alpha:rgba(255,120,0,.2);--primary-color:#ff7800}</style><script src=https://bolives-hax.github.io/copy-button.js></script><link href=https://bolives-hax.github.io/favicon.png rel=icon type=image/png><link href=https://bolives-hax.github.io/apple-touch-icon.png rel=apple-touch-icon sizes=180x180 type=image/png><meta property=og:site_name><meta content="making use of dyalog APL's isolates+futures in the the apl raymarcher - " property=og:title><meta content=https://bolives-hax.github.io/Blog/bringing-dyalogs-isolates-and-futres-to-the-apl-raymarcher/ property=og:url><meta content="bringing dyalogs isolates and futures to the apl raymarcher" property=og:description><meta content=https://bolives-hax.github.io/card.png property=og:image><meta content=summary_large_image property=twitter:card><body><header id=site-nav><nav><a href=#main id=main-content tabindex=0>Skip to main content</a><ul><li id=home><a href=https://bolives-hax.github.io> </a><li><a href=https://bolives-hax.github.io/Blog/> Blog </a><li><a href=https://bolives-hax.github.io/> / </a><li id=feed><a href=https://bolives-hax.github.io/atom.xml> <svg viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><path d="M1.988 1.988V3c.008.547.453.984 1 .988.004-.004.008-.004.012-.004v.028A8.977 8.977 0 0 1 11.988 13a.991.991 0 0 0 1 .984h1V13h-.004c0-.004 0-.004.004-.008C13.984 7.02 9.184 2.148 3.242 2.02A1.004 1.004 0 0 0 3 1.988v-.004zm0 4V7c.008.547.453.984 1 .988.004-.004.008-.004.012-.004V8a4.985 4.985 0 0 1 4.996 4.844 1.002 1.002 0 0 0 .988 1.145c.008-.005.012-.005.016-.005v.004h.984V13H10c0-3.793-3.047-6.898-6.82-6.992 0-.004-.004-.004-.004-.004A.892.892 0 0 0 3 5.988v-.004zm2 4a1.999 1.999 0 1 0-.002 3.998 1.999 1.999 0 0 0 .002-3.998m0 0"></path></svg> <span>Feed</span> </a></ul></nav></header><div class=container id=main><article><h1>making use of dyalog APL's isolates+futures in the the apl raymarcher</h1><small> <time datetime=" 2024-05-02T00:00:00+00:00" pubdate>02 May 2024</time> <span>•</span> <span>Author: bl0v3</span> <span>•</span> <ul class=tags><li><a class=tag href=https://bolives-hax.github.io/tags/apl/>APL</a><li><a class=tag href=https://bolives-hax.github.io/tags/dyalog/>dyalog</a><li><a class=tag href=https://bolives-hax.github.io/tags/isolates/>isolates</a><li><a class=tag href=https://bolives-hax.github.io/tags/paralleleach/>parallelEach</a><li><a class=tag href=https://bolives-hax.github.io/tags/multi-threading/>multi-threading</a><li><a class=tag href=https://bolives-hax.github.io/tags/demo/>demo</a><li><a class=tag href=https://bolives-hax.github.io/tags/raymarching/>raymarching</a><li><a class=tag href=https://bolives-hax.github.io/tags/3d-graphics/>3D Graphics</a><li><a class=tag href=https://bolives-hax.github.io/tags/dyalog/>dyalog</a><li><a class=tag href=https://bolives-hax.github.io/tags/math/>math</a></ul> </small><div class="statement-container trigger"><strong class=big> <svg viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><path d="M7.906.094C7.38.066 6.867.375 6.47 1.063L.219 12.656C-.316 13.621.266 15 1.313 15h13.156c.98 0 1.902-1.16 1.219-2.344L9.375 1.125C8.977.48 8.434.121 7.906.094M9 4v5c.008.527-.473 1-1 1s-1.008-.473-1-1V4zm-1 7c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1m0 0"/></svg> Trigger Warning </strong><p>skip to the “actual implementation” headline/section if you aren’t interesting in the nix specific issues that had to be overcome in order to get dyalog-apl running along with futures and isolates</div><h1 id=overcoming-nix-specific-issues-to-get-isolates-and-futures-to-work>overcoming nix specific issues to get isolates and futures to work</h1><p><strong>(skip to “actual implementation” below if this this isn’t of any interest to you)</strong><p>Unlike I initially assumed just importing the isolate workspace on dyalog-apl retrived trough nix’s nixpkgs ( as I used that to produce these builds in a reproducible/declarative fashion) wasn’t directly feasible as upon loading the workspace I’d get some quite strange errors. Upon further debugging this issue I came to the conclusion that it was caused by the nix derivation for dyalog-apl rather than dyalog apl itself.<p>So after opening an issue and notifying the package maintainer at <a href=https://github.com/NixOS/nixpkgs/issues/316439>dyalog: isolates (parallel forEach and co) appear to be broken #316439</a> it seems as if they managed to fix it via <a href=https://github.com/NixOS/nixpkgs/pull/316495>dyalog: also apply patchelf to dyalog.rt #316495</a><p>The issue basically boils down to the following:<p>As nix stores all binaries/libraries in <code>/nix/store/&LThash>-&LTpath></code> packaging binary executables can be a litty funny at times. As obtaining the source code for dyalog-apl isn’t possible as for now were forced to work with the .deb/.rpm etc packages they provide. Which is exactly what the nix expression linked above does.<p>But just copying the contents of that .deb to /bin and /lib respectively isn’t all there is to it sadly as binary packages already have pre defined <a href=https://en.m.wikipedia.org/wiki/Executable_and_Linkable_Format>ELF headers</a> these make assumptions about the names and locations of the library components to be loaded upon executing the elf by the linux kernel.<p>like mentioned in the issue the maintainer forgot to also add ncurses to <code>dyalog.rt</code> luckily as the elf specification is simple enough</p><img src=https://raw.githubusercontent.com/corkami/pics/master/binary/elf101/elf101.svg><p>to alter using tools such as <code>patchelf</code>, which is very frequently seen when packaging binary packages for nix/nixos.<p>Thus everything required to do was changing<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patchelf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">dyalogHome</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span>/dyalog<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>add-needed</span> libncurses.so</span>
</span></code></pre><p>to<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-for z-shell">for</span><span class="z-meta z-group z-for z-shell"> exec <span class="z-keyword z-control z-in z-shell">in</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>dyalog<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>dyalog.rt<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-loop z-do z-shell">do</span>
</span><span class="z-source z-shell z-bash">     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">patchelf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">dyalogHome</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span>/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">exec</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>add-needed</span> libncurses.so</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-end z-shell">done</span>
</span></code></pre><p>within the nix expression. Which the maintainer did an awesome job of figuring out <a href=https://github.com/NixOS/nixpkgs/pull/316495/commits/0ea7fe9f11803bea5fd9f6b2ecd96fd96b0731e7>see</a><p>Thus using the package with the previous expression running ldd would result in<pre class=z-code><code><span class="z-text z-plain">linux-vdso.so.1 (0x00007ffff7fc6000)
</span><span class="z-text z-plain">libm.so.6 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libm.so.6 (0x00007ffff7edd000)
</span><span class="z-text z-plain">libpthread.so.0 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libpthread.so.0 (0x00007ffff7ed8000)
</span><span class="z-text z-plain">libdl.so.2 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libdl.so.2 (0x00007ffff7ed3000)
</span><span class="z-text z-plain">libc.so.6 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libc.so.6 (0x00007ffff7213000)
</span><span class="z-text z-plain">/nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/ld-linux-x86-64.so.2 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib64/ld-linux-x86-64.so.2 (0x00007ffff7fc8000)
</span></code></pre><p>while using the fixed drv with ncurses being added to the elf header would result in<pre class=z-code><code><span class="z-text z-plain">linux-vdso.so.1 (0x00007ffff7fc6000)
</span><span class="z-text z-plain">libncurses.so => /nix/store/zcjy82jk8i8y1cvvzaadj5wiz41gvp53-ncurses-abi5-compat-6.4/lib/libncurses.so (0x00007ffff7f58000)
</span><span class="z-text z-plain">libm.so.6 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libm.so.6 (0x00007ffff7e75000)
</span><span class="z-text z-plain">libpthread.so.0 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libpthread.so.0 (0x00007ffff7e70000)
</span><span class="z-text z-plain">libdl.so.2 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libdl.so.2 (0x00007ffff7e6b000)
</span><span class="z-text z-plain">libc.so.6 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/libc.so.6 (0x00007ffff7213000)
</span><span class="z-text z-plain">/nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib/ld-linux-x86-64.so.2 => /nix/store/k7zgvzp2r31zkg9xqgjim7mbknryv6bs-glibc-2.39-52/lib64/ld-linux-x86-64.so.2 (0x00007ffff7fc8000)
</span></code></pre><p>note <code>libncurses.so => /nix/store/zcjy82jk8i8y1cvvzaadj5wiz41gvp53-ncurses-abi5-compat-6.4/lib/libncurses.so (0x00007ffff7f58000)</code> being present now after applying the fix<p>So until that PR/commit is merged into nixpkgs I’d have to specify:<pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">inputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">nixpkgs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">url</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>https://github.com/TomaSajt/nixpkgs.git<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">type</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>git<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">rev</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>0ea7fe9f11803bea5fd9f6b2ecd96fd96b0731e7<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-comment z-line z-number-sign z-nix"># other inputs ...</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><p>within my flake.nix expression used to build this project. If you aren’t using nix but the rpm/deb package youd of course not have to do this.<p>Another approach of solving this issue would be using <a href=https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/>buildFHSEnv</a> which I would have done if me or the maintainers couldn’t figure out how to fix this in time.<p>As <em>buildFHS env uses Linux’ namespaces feature to create temporary lightweight environments which are destroyed after all child processes exit, without requiring elevated privileges. It works similar to containerisation technology such as Docker or FlatPak but provides no security-relevant separation from the host system</em><p>this implies the presence of a namespace enabled linux kernel which would break nix’s excellent macos/darwin support as well as nix on non namespace enabled linux systems. So in order to keep the majority of nixpkgs functional on macos and non-nixos systems <em>(by the way nix is availible in the debian/arch repos by default)</em> patchelf is generally to be favored. But in especially nasty cases such as where precompiled (e.g nonfree packages such as steam lets say) packages are expecting certain binaries or files in general to be present in <strong>/sbin/</strong> , <strong>/bin/</strong> or <strong>/usr/bin</strong> and the files are sourced at runtime rather than via the elf header upon program load. buildFHS would have to be used as thats a better approach than trying to binary-patch the hardcoded references within the compiled software.<h1 id=actual-implementation>actual implementation</h1><p>Since <a href=https://github.com/bolives-hax/apl-raymarcher/commit/ddde091fa2cb4c635cc6a1e39a2f4f6183852317>this commit</a> multithreading is now availible<p>While at the time of writing this the amount of theads is hardcoded via <code>threads←4</code> in flake.nix but you are free to changing the amount of threads by either altering the <code>raymarcher.apl</code> file or the flake.nix file accordingly (see flake.nix to see what variables need to be applied). Thus rendering with much more than 4 threads is totally feasible and it does seem to be able to truly utilize all resources given to it perfectly fine.<p>See (rendering in 4K):</p><img src="https://github.com/bolives-hax/apl-raymarcher/blob/master/multithread-showcase.jpg?raw=true"><p>(TODO actually explain how this was pulled off. Until then check <code>raymarcher.apl</code>’s comments that were added in the commit linked above</article><hr><nav id=post-nav><a class="post-nav-item post-nav-prev" href=https://bolives-hax.github.io/Blog/zola-meets-nix/> <div class=nav-arrow>← Previous</div> <span class=post-title>how I build this blog</span> </a></nav><p class=dialog-buttons><a class=inline-button href=#top>Go to Top</a></div><footer id=site-footer></footer>